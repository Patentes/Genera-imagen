<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Imagen para Impresión</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f6f6;
      text-align: center;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    input, button, select {
      margin: 10px;
      padding: 8px;
      max-width: 100%;
      box-sizing: border-box;
    }
    input[type="text"] {
      width: 80%;
      font-size: 18px;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
      max-width: 100%;
      background-color: #FFFFFF !important; /* Fondo blanco puro para el canvas */
    }
    #canvasContainer {
      background-color: #FFFFFF;
      display: inline-block;
      padding: 5px;
      border: 1px solid #ddd;
    }
    .hidden {
      display: none;
    }
    .notification {
      background-color: #4CAF50;
      color: white;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
    }
    .error-notification {
      background-color: #f44336;
    }
    #descargarBtn {
      display: inline-block;
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 4px;
      margin-top: 10px;
    }
    /* Estilos para botón imprimir */
    #imprimirBtn {
      display: inline-block;
      background-color: #2196F3;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 4px;
      margin-top: 10px;
      margin-left: 10px;
    }
    /* Estilos para botón generar */
    #generarBtn {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      font-size: 18px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Estilos responsive para móviles */
    @media screen and (max-width: 600px) {
      body {
        padding: 10px;
      }
      canvas {
        width: 90%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Generador de Imagen para Impresión</h1>
    <input type="text" id="texto" placeholder="Escribe aquí letras o número" autofocus>
    <br>
    Tamaño del texto: <strong id="tamanioTextoLabel">24</strong> px
    <br>
    <input type="range" id="tamanioTexto" min="10" max="100" value="24">
    <br>
    <button id="generarBtn" onclick="generarImagen()">Generar e Imprimir</button>
    <br>
    <div id="canvasContainer">
      <canvas id="canvas" width="200" height="100"></canvas>
    </div>
    <br>
    <a id="descargarBtn" download="patente.png" class="hidden">Descargar Imagen</a>
    
    <div id="notificacion" class="notification">Notificación enviada</div>
    <div id="errorNotificacion" class="notification error-notification">Error al enviar notificación</div>
  </div>

  <script>
    // Para depuración - Mostrar información del dispositivo al inicio
    console.log("Iniciando aplicación en dispositivo");
    console.log("User Agent:", navigator.userAgent);
    console.log("Plataforma:", navigator.platform);
    
    let imagenGenerada = null;
    
    // Variables para impresora específica del Q2i P716QJ-E1X
    let isPosDevice = false;
    let printerModule = null;
    
    // Intentar cargar el objeto de impresora tan pronto como el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOM cargado - intentando acceder a las APIs de impresión");
      buscarImpresoraQ2i();
    });

    window.onload = function() {
      // Intentar acceder a impresora si no se ha hecho ya
      if (!printerModule) {
        buscarImpresoraQ2i();
      }

      // Configurar color de fondo del canvas al cargar
      const canvas = document.getElementById('canvas');
      if (canvas) {
        canvas.style.backgroundColor = "#FFFFFF";
        const ctx = canvas.getContext('2d', { alpha: false });
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
      
      // Configurar evento Enter para el campo de texto
      document.getElementById('texto').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          generarImagen();
        }
      });
    };
    
    // Función específica para buscar impresora en Q2i P716QJ-E1X
    function buscarImpresoraQ2i() {
      console.log("Buscando impresora en dispositivo Q2i P716QJ-E1X");
      
      try {
        // Intentar múltiples métodos para obtener la impresora
        
        // 1. Objetos específicos para este modelo
        if (window.P716) {
          console.log("Detectado objeto P716");
          printerModule = window.P716;
          isPosDevice = true;
        }
        // 2. API específica de Q2i
        else if (window.Q2i && window.Q2i.printer) {
          console.log("Detectado objeto Q2i.printer");
          printerModule = window.Q2i.printer;
          isPosDevice = true;
        }
        // 3. Objeto printer directo
        else if (window.printer) {
          console.log("Detectado objeto window.printer");
          printerModule = window.printer;
          isPosDevice = true;
        }
        // 4. Object Woyou (común en impresoras térmicas chinas)
        else if (window.woyou) {
          console.log("Detectado objeto window.woyou");
          printerModule = window.woyou;
          isPosDevice = true;
        }
        // 5. Objeto android nativo (última opción)
        else if (window.android) {
          console.log("Detectado objeto window.android");
          printerModule = window.android;
          isPosDevice = true;
          
          // Intentar descubrir métodos disponibles
          console.log("Métodos disponibles en window.android:");
          for (let prop in window.android) {
            if (typeof window.android[prop] === 'function') {
              console.log(" - " + prop);
            }
          }
        }
        // 6. Para la versión específica P716QJ-E1X, verificar objeto global P716QJ
        else if (window.P716QJ) {
          console.log("Detectado objeto P716QJ específico del hardware");
          printerModule = window.P716QJ;
          isPosDevice = true;
        }
        
        // Si no encuentra ninguno de los anteriores, buscar métodos relacionados con impresión
        if (!printerModule) {
          console.log("Buscando objetos alternativos con funciones de impresión:");
          for (let key in window) {
            try {
              if (typeof window[key] === 'object' && window[key] !== null) {
                // Verificar si el objeto tiene métodos relacionados con impresión
                for (let method in window[key]) {
                  if ((method.toLowerCase().includes('print') || 
                       method.toLowerCase().includes('imprimir') ||
                       method.toLowerCase().includes('escpos')) && 
                      typeof window[key][method] === 'function') {
                    console.log(`Posible API de impresión encontrada: window.${key}.${method}`);
                    printerModule = window[key];
                    isPosDevice = true;
                    break;
                  }
                }
              }
            } catch (e) {
              // Ignorar errores al acceder a propiedades
            }
          }
        }
      } catch (error) {
        console.error("Error al buscar impresora:", error);
      }
      
      if (isPosDevice && printerModule) {
        console.log("Impresora detectada y accesible");
      } else {
        console.log("No se detectó impresora específica - se utilizará simulación");
        // En un Q2i siempre asumimos que hay impresora aunque no la detectemos por software
        isPosDevice = true;
      }
    }
    
    document.getElementById('tamanioTexto').addEventListener('input', e => {
      document.getElementById('tamanioTextoLabel').textContent = e.target.value;
    });

    function generarImagen() {
      const texto = document.getElementById('texto').value;
      if (!texto) {
        alert("Por favor ingresa un texto para imprimir");
        return;
      }
      
      const tamanio = document.getElementById('tamanioTexto').value;
      const canvas = document.getElementById('canvas');
      
      // Aumentar la resolución del canvas (factor 4x para mejor calidad)
      const factorEscala = 4; // Mejor calidad
      canvas.width = 200 * factorEscala;
      canvas.height = 100 * factorEscala;
      
      // Mantener el tamaño visual en la página mediante CSS
      canvas.style.width = "200px";
      canvas.style.height = "100px";
      
      // Asegurar que el canvas tenga fondo blanco
      canvas.style.backgroundColor = "#FFFFFF";
      document.getElementById('canvasContainer').style.backgroundColor = "#FFFFFF";
      
      const ctx = canvas.getContext('2d', { alpha: false }); // Deshabilitar transparencia
      
      // Limpiar completamente el canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Primero dibujamos un fondo blanco puro para asegurar que no sea transparente
      ctx.fillStyle = "#FFFFFF";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Escalar el contexto para compensar el aumento de resolución
      ctx.scale(factorEscala, factorEscala);
      
      // Ajuste para mejorar la nitidez de la fuente
      ctx.font = `${tamanio}px Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#000000"; // Negro puro para el texto
      
      // Asegurar que dibujamos en el centro correcto
      ctx.fillText(texto, canvas.width / (2 * factorEscala), canvas.height / (2 * factorEscala));
      
      // Restaurar la escala para futuros dibujos
      ctx.setTransform(1, 0, 0, 1, 0, 0);

      imagenGenerada = canvas.toDataURL('image/png', 1.0);  // Máxima calidad

      // Habilitar descarga
      const enlace = document.getElementById('descargarBtn');
      enlace.classList.remove('hidden');
      enlace.textContent = "Descargar Imagen";

      // Configurar el enlace de descarga
      configurarEnlaceDescarga();

      // Imprimir directamente
      imprimirDirectamente(texto);
      
      // Limpiar el campo de texto y enfocarlo para la siguiente entrada
      document.getElementById('texto').value = '';
      document.getElementById('texto').focus();
    }

    function configurarEnlaceDescarga() {
      const enlace = document.getElementById('descargarBtn');
      const canvas = document.getElementById('canvas');
      
      // Asegurar que la imagen tenga fondo blanco puro antes de generar la URL
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d', { alpha: false }); // Deshabilitar transparencia
      
      // Dibujar fondo blanco puro
      tempCtx.fillStyle = '#FFFFFF';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
      
      // Dibujar la imagen del canvas original encima
      tempCtx.drawImage(canvas, 0, 0);
      
      // Generar URL a partir del canvas temporal con fondo blanco puro
      const imagenURL = tempCanvas.toDataURL('image/png', 1.0);
      
      // Pre-cargar una imagen para verificar que el fondo sea correcto
      const img = new Image();
      img.onload = function() {
        const verifyCanvas = document.createElement('canvas');
        verifyCanvas.width = img.width;
        verifyCanvas.height = img.height;
        const verifyCtx = verifyCanvas.getContext('2d');
        verifyCtx.fillStyle = '#FFFFFF';
        verifyCtx.fillRect(0, 0, verifyCanvas.width, verifyCanvas.height);
        verifyCtx.drawImage(img, 0, 0);
        
        // Usar esta imagen verificada para la descarga
        enlace.href = verifyCanvas.toDataURL('image/png', 1.0);
      };
      img.src = imagenURL;
    }
    
    // Función para generar imagen optimizada para impresión
    function generarImagenParaImprimir(texto, callback) {
      const tamanio = document.getElementById('tamanioTexto').value;
      const canvas = document.getElementById('canvas');
      
      // Actualizar tamaño para impresión térmica (optimizado para 58mm)
      const ancho = 58 * 8; // 8 pixels por mm es un buen estándar para impresoras térmicas
      canvas.width = ancho;
      canvas.height = 100;
      
      // Mantener el tamaño visual en la página mediante CSS
      canvas.style.width = "200px";
      canvas.style.height = "100px";
      
      const ctx = canvas.getContext('2d', { alpha: false });
      
      // Limpiar completamente el canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Fondo blanco
      ctx.fillStyle = "#FFFFFF";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Configurar texto
      ctx.fillStyle = "#000000";
      ctx.font = `bold ${tamanio}px Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      
      // Dibujar texto
      ctx.fillText(texto, canvas.width / 2, canvas.height / 2);
      
      // Guardar la imagen generada
      imagenGenerada = canvas.toDataURL('image/png', 1.0);
      
      // Callback después de generar la imagen
      if (typeof callback === 'function') {
        callback();
      }
    }
    
    // Función para imprimir directamente
    function imprimirDirectamente(texto) {
      if (!texto) {
        texto = document.getElementById('texto').value;
        if (!texto) {
          alert("Por favor ingresa un texto para imprimir");
          return;
        }
      }
      
      // Mostrar notificación de inicio
      mostrarNotificacion("Iniciando impresión...");
      
      // Generar imagen actualizada
      generarImagenParaImprimir(texto, function() {
        // Llamar a la función principal de impresión
        imprimirEnQ2i(texto);
      });
    }
    
    // Función especializada para imprimir en Q2i P716QJ-E1X
    function imprimirEnQ2i(texto) {
      console.log("Imprimiendo texto:", texto);
      
      // Obtener el tamaño del texto
      const tamanio = document.getElementById('tamanioTexto').value;
      const canvas = document.getElementById('canvas');
      
      try {
        let impresionExitosa = false;
        
        // ==========================================
        // MÉTODO 1: Usando IntentOS para dispositivos Q2i
        // ==========================================
        if (!impresionExitosa) {
          try {
            console.log("Intentando imprimir vía actividad nativa (IntentOS)");
            
            // Crear un iframe oculto para invocar el esquema intent://
            const intentFrame = document.createElement('iframe');
            intentFrame.style.display = 'none';
            // Esquema específico para Q2i con impresora térmica
            intentFrame.src = `intent://print?text=${encodeURIComponent(texto)}&size=${tamanio}#Intent;scheme=q2printer;package=com.q2i.printer;end`;
            document.body.appendChild(intentFrame);
            
            // Eliminar el iframe después de un segundo
            setTimeout(() => {
              document.body.removeChild(intentFrame);
            }, 1000);
            
            impresionExitosa = true;
            mostrarNotificacion("Solicitud de impresión enviada al sistema");
          } catch (e) {
            console.error("Error al imprimir vía intent:", e);
          }
        }
        
        // ==========================================
        // MÉTODO 2: API específica P716QJ-E1X
        // ==========================================
        if (!impresionExitosa && printerModule) {
          try {
            // Detectar el método adecuado para imprimir
            if (printerModule.printText) {
              console.log("Imprimiendo con printerModule.printText");
              printerModule.printText(texto);
              impresionExitosa = true;
            }
            else if (printerModule.print) {
              console.log("Imprimiendo con printerModule.print");
              if (typeof printerModule.print === 'function') {
                // Si es una función, puede aceptar texto directo o un objeto de configuración
                try {
                  printerModule.print(texto);
                } catch (e) {
                  // Si falla, intentar como objeto
                  printerModule.print({
                    text: texto,
                    size: tamanio
                  });
                }
                impresionExitosa = true;
              }
            }
            else if (printerModule.printString) {
              console.log("Imprimiendo con printerModule.printString");
              printerModule.printString(texto);
              impresionExitosa = true;
            }
            
            // Intentar cortar papel si está disponible
            if (impresionExitosa) {
              console.log("Impresión exitosa, intentando cortar papel");
              try {
                if (printerModule.cutPaper) {
                  printerModule.cutPaper();
                } else if (printerModule.cut) {
                  printerModule.cut();
                }
              } catch (e) {
                console.log("Error al cortar papel (no crítico):", e);
              }
            }
          } catch (e) {
            console.error("Error al imprimir con API específica:", e);
          }
        }
        
        // ==========================================
        // MÉTODO 3: Usando JSBridge (común en dispositivos chinos)
        // ==========================================
        if (!impresionExitosa && window.JSBridge) {
          try {
            console.log("Intentando imprimir vía JSBridge");
            if (window.JSBridge.print) {
              window.JSBridge.print(texto);
              impresionExitosa = true;
            } else if (window.JSBridge.printer && window.JSBridge.printer.print) {
              window.JSBridge.printer.print(texto);
              impresionExitosa = true;
            }
          } catch (e) {
            console.error("Error con JSBridge:", e);
          }
        }
        
        // ==========================================
        // MÉTODO 4: Implementación alternativa directa a AIDL
        // ==========================================
        if (!impresionExitosa && window.aidl) {
          try {
            console.log("Intentando imprimir vía AIDL");
            if (window.aidl.printer && window.aidl.printer.printText) {
              window.aidl.printer.printText(texto);
              impresionExitosa = true;
            }
          } catch (e) {
            console.error("Error con AIDL:", e);
          }
        }
        
        // ==========================================
        // MÉTODO 5: Llamada directa a Android (último recurso)
        // ==========================================
        if (!impresionExitosa && window.android) {
          try {
            console.log("Intentando métodos directos de Android");
            
            if (window.android.printText) {
              window.android.printText(texto);
              impresionExitosa = true;
            } else if (window.android.print) {
              if (typeof window.android.print === 'function') {
                window.android.print(texto);
                impresionExitosa = true;
              }
            } else if (window.android.callPrintService) {
              window.android.callPrintService("print", JSON.stringify({
                text: texto,
                fontSize: tamanio
              }));
              impresionExitosa = true;
            } else {
              // Imprimir caracteres ESC/POS directamente (avanzado)
              const bytes = generarComandosESCPOS(texto, tamanio);
              if (window.android.printRawData) {
                window.android.printRawData(bytes);
                impresionExitosa = true;
              } else if (window.android.sendRAWData) {
                window.android.sendRAWData(bytes);
                impresionExitosa = true;
              }
            }
            
            // Intentar cortar papel
            if (impresionExitosa && window.android.cutPaper) {
              window.android.cutPaper();
            }
          } catch (e) {
            console.error("Error con Android API:", e);
          }
        }
        
        // ==========================================
        // RESULTADO FINAL
        // ==========================================
        if (impresionExitosa) {
          mostrarNotificacion("Impresión completada");
        } else {
          // Si todo falla, mostrar error e intentar la simulación
          console.warn("Todos los métodos de impresión fallaron, utilizando simulación");
          mostrarError("No se pudo acceder a la impresora. Usando simulación.");
          simularImpresion(texto);
        }
        
      } catch (error) {
        console.error("Error general al imprimir:", error);
        mostrarError("Error de impresión. Usando simulación.");
        simularImpresion(texto);
      }
    }
    
    // Generar comandos ESC/POS para impresoras térmicas
    function generarComandosESCPOS(texto, tamanio) {
      // Comandos básicos ESC/POS para impresora térmica
      const ESC = 0x1B;  // Escape
      const GS = 0x1D;   // Group Separator
      
      // Crear array para comandos
      const comandos = [];
      
      // 1. Inicializar impresora
      comandos.push(ESC, 0x40);  // ESC @
      
      // 2. Centrar texto
      comandos.push(ESC, 0x61, 0x01);  // ESC a 1
      
      // 3. Tamaño del texto (multiplicador de tamaño)
      let multiplicador = 0;
      if (tamanio <= 12) multiplicador = 0;      // Normal
      else if (tamanio <= 20) multiplicador = 1; // Medio
      else if (tamanio <= 32) multiplicador = 2; // Grande
      else multiplicador = 3;                    // Muy grande
      
      // GS ! n - donde n es el tamaño (bit 0-3 para ancho, 4-7 para alto)
      const tamañoComando = (multiplicador << 4) | multiplicador;
      comandos.push(GS, 0x21, tamañoComando);
      
      // 4. Texto a imprimir
      const textoBytes = [];
      for (let i = 0; i < texto.length; i++) {
        textoBytes.push(texto.charCodeAt(i));
      }
      comandos.push(...textoBytes);
      
      // 5. Salto de línea
      comandos.push(0x0A, 0x0A); // LF LF (dos saltos de línea)
      
      // 6. Corte de papel
      comandos.push(GS, 0x56, 0x00); // GS V 0 - corte completo
      
      // Convertir a string o array depende de la API
      return comandos;
    }
    
    // Simulación de impresión para casos fallidos o pruebas
    function simularImpresion(texto) {
      // Generar la imagen primero
      generarImagenParaImprimir(texto, function() {
        // Mostrar una notificación de "imprimiendo"
        mostrarNotificacion("Simulando impresión...");
        
        // Simular un tiempo de impresión
        setTimeout(function() {
          mostrarNotificacion("Impresión completada (simulación)");
        }, 1500);
      });
    }
    
    // Función para mostrar notificación en la interfaz
    function mostrarNotificacion(mensaje) {
      const notificacion = document.getElementById("notificacion");
      if (notificacion) {
        notificacion.textContent = mensaje;
        notificacion.style.display = "block";
        
        // Ocultar la notificación de error si está visible
        const errorNotificacion = document.getElementById("errorNotificacion");
        if (errorNotificacion) {
          errorNotificacion.style.display = "none";
        }
        
        // Registrar en consola para depuración
        console.log("Notificación: " + mensaje);
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
          notificacion.style.display = "none";
        }, 3000);
      } else {
        // Si no está el elemento en pantalla (página cerrada)
        console.log("Notificación (silenciosa): " + mensaje);
      }
    }
    
    // Función para mostrar errores en la interfaz
    function mostrarError(mensaje) {
      const errorNotificacion = document.getElementById("errorNotificacion");
      if (errorNotificacion) {
        errorNotificacion.textContent = mensaje;
        errorNotificacion.style.display = "block";
        
        // Ocultar la notificación normal si está visible
        const notificacion = document.getElementById("notificacion");
        if (notificacion) {
          notificacion.style.display = "none";
        }
        
        // Registrar en consola para depuración
        console.error("Error: " + mensaje);
        
        // Ocultar después de 5 segundos
        setTimeout(() => {
          errorNotificacion.style.display = "none";
        }, 5000);
      } else {
        // Si no está el elemento en pantalla (página cerrada)
        console.error("Error (silencioso): " + mensaje);
      }
    }
  </script>
</body>
</html>
